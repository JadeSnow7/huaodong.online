<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TCP 三次握手与四次挥手 | 学习笔记</title>
    <meta name="description" content="深入分析 TCP 连接建立与断开的完整流程。" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="note-style.css" />
</head>

<body>
    <div class="backdrop" aria-hidden="true">
        <span class="orb orb--one"></span>
        <span class="orb orb--two"></span>
        <span class="orb orb--three"></span>
        <span class="grid"></span>
    </div>

    <header class="site-header">
        <a href="../index.html" class="brand">HU AODONG</a>
        <nav class="nav">
            <a href="../index.html#projects">精选项目</a>
            <a href="index.html" class="active">学习笔记</a>
            <a href="../resume.html">在线简历</a>
        </nav>
    </header>

    <main class="note-container">
        <article class="note-article">
            <header class="note-header">
                <a href="index.html" class="note-back">← 返回笔记列表</a>
                <span class="note-category network">计算机网络</span>
                <h1>TCP 三次握手与四次挥手</h1>
                <div class="note-meta">
                    <span>📅 2026-01-15</span>
                    <span>⏱️ 约 8 分钟</span>
                    <span>🏷️ TCP, 协议, 网络</span>
                </div>
            </header>

            <div class="note-content">
                <h2>1. TCP 协议概述</h2>
                <p>TCP (Transmission Control Protocol) 是一种<strong>面向连接的可靠传输协议</strong>，位于传输层。它通过三次握手建立连接，四次挥手断开连接。</p>

                <div class="info-box">
                    <h4>📡 TCP 特点</h4>
                    <ul>
                        <li><strong>面向连接</strong>：通信前需要建立连接</li>
                        <li><strong>可靠传输</strong>：确认机制、重传机制、序号机制</li>
                        <li><strong>流量控制</strong>：滑动窗口机制</li>
                        <li><strong>拥塞控制</strong>：慢启动、拥塞避免、快重传、快恢复</li>
                    </ul>
                </div>

                <h2>2. 三次握手 (Three-Way Handshake)</h2>

                <pre><code>     客户端                                    服务端
        |                                         |
        |  -------- SYN, seq=x --------->         |
        |  (SYN_SENT)                  (LISTEN)   |
        |                                         |
        |  <----- SYN+ACK, seq=y, ack=x+1 ----    |
        |                              (SYN_RCVD) |
        |                                         |
        |  -------- ACK, ack=y+1 --------->       |
        |  (ESTABLISHED)           (ESTABLISHED)  |
        |                                         |</code></pre>

                <h3>2.1 详细过程</h3>

                <table class="note-table">
                    <thead>
                        <tr>
                            <th>步骤</th>
                            <th>发送方</th>
                            <th>报文内容</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>第一次</td>
                            <td>客户端</td>
                            <td>SYN=1, seq=x</td>
                            <td>请求建立连接，发送初始序号</td>
                        </tr>
                        <tr>
                            <td>第二次</td>
                            <td>服务端</td>
                            <td>SYN=1, ACK=1, seq=y, ack=x+1</td>
                            <td>确认客户端请求，发送自己的初始序号</td>
                        </tr>
                        <tr>
                            <td>第三次</td>
                            <td>客户端</td>
                            <td>ACK=1, ack=y+1</td>
                            <td>确认服务端响应，连接建立</td>
                        </tr>
                    </tbody>
                </table>

                <div class="qa-box">
                    <p class="question">Q: 为什么是三次握手而不是两次？</p>
                    <p class="answer">A: 防止已失效的连接请求报文突然传到服务端。如果只有两次，服务端收到旧的 SYN
                        后会直接建立连接，造成资源浪费。第三次握手让服务端确认客户端确实想要建立这个连接。</p>
                </div>

                <h2>3. 四次挥手 (Four-Way Handshake)</h2>

                <pre><code>     客户端                                    服务端
        |                                         |
        |  -------- FIN, seq=u --------->         |
        |  (FIN_WAIT_1)            (ESTABLISHED)  |
        |                                         |
        |  <------- ACK, ack=u+1 --------         |
        |  (FIN_WAIT_2)              (CLOSE_WAIT) |
        |                                         |
        |  <------- FIN, seq=w --------           |
        |                               (LAST_ACK)|
        |                                         |
        |  -------- ACK, ack=w+1 --------->       |
        |  (TIME_WAIT)                   (CLOSED) |
        |                                         |
        |  ... 等待 2MSL ...                      |
        |  (CLOSED)                               |</code></pre>

                <h3>3.1 为什么需要四次挥手？</h3>
                <p>TCP 是<strong>全双工</strong>协议，两个方向需要分别关闭：</p>
                <ul>
                    <li>客户端发送 FIN 表示不再发送数据</li>
                    <li>服务端确认后可能还有数据要发送</li>
                    <li>服务端数据发送完毕后发送 FIN</li>
                    <li>客户端确认后连接彻底关闭</li>
                </ul>

                <h2>4. 重要状态说明</h2>

                <div class="warning-box">
                    <h4>⚠️ TIME_WAIT 状态</h4>
                    <ul>
                        <li>持续时间：2MSL（Maximum Segment Lifetime，通常 60 秒）</li>
                        <li><strong>作用一</strong>：确保最后的 ACK 能到达服务端</li>
                        <li><strong>作用二</strong>：等待网络中残余报文消失，避免影响新连接</li>
                        <li><strong>问题</strong>：高并发场景下可能耗尽端口</li>
                        <li><strong>优化</strong>：设置 <code>SO_REUSEADDR</code> 或调整内核参数</li>
                    </ul>
                </div>

                <h2>5. 常见面试题</h2>

                <div class="qa-box">
                    <p class="question">Q: TCP 如何保证可靠传输？</p>
                    <p class="answer">A: ① 序号机制：每个字节都有序号；② 确认应答：接收方发送 ACK；③ 超时重传：未收到确认则重发；④ 校验和：检测数据完整性；⑤ 流量控制：滑动窗口；⑥
                        拥塞控制：防止网络过载。</p>
                </div>

                <div class="qa-box">
                    <p class="question">Q: SYN 攻击是什么？如何防御？</p>
                    <p class="answer">A: 攻击者发送大量伪造源 IP 的 SYN 请求，服务端回复 SYN+ACK 后等待确认，耗尽资源。防御方法：① SYN Cookie 技术；②
                        限制半连接数量；③ 缩短 SYN 超时时间；④ 使用防火墙过滤。</p>
                </div>

                <div class="qa-box">
                    <p class="question">Q: 什么是 TCP 粘包？如何解决？</p>
                    <p class="answer">A: TCP 是字节流协议，没有消息边界概念，多个小包可能被合并发送，或一个大包被拆分。解决方法：① 固定长度协议；② 分隔符协议；③ 长度前缀协议（推荐）。
                    </p>
                </div>
            </div>

            <footer class="note-footer">
                <div class="note-nav">
                    <a href="client-mvvm-architecture.html" class="prev">← MVVM 架构模式</a>
                    <a href="os-process-thread.html" class="next">进程与线程 →</a>
                </div>
            </footer>
        </article>
    </main>

    <footer class="site-footer">
        <p>© Hu Aodong · Crafted for GitHub Pages</p>
    </footer>
</body>

</html>